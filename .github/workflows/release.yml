name: Release

on:
    push:
        tags:
            - "*"

env:
    BROWSER_EXTENSION_NAME: snippet-leaf-browser
    CODEMIRROR_EXTENSION_NAME: snippet-leaf-codemirror

jobs:
    build-browser-extension:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 18

            - name: Build Browser Extension
              id: build
              run: |
                  npm install
                  npm run web:build

                  # Create browser extension package
                  mkdir -p ${{ env.BROWSER_EXTENSION_NAME }}
                  cd browser_extension
                  cp -r dist/ manifest.json popup.html popup.js settings.html styles.css ../${{ env.BROWSER_EXTENSION_NAME }}/
                  cd ..
                  zip -r ${{ env.BROWSER_EXTENSION_NAME }}.zip ${{ env.BROWSER_EXTENSION_NAME }}
                  echo "tag_name=${{ needs.detect-release-type.outputs.tag_name }}" >> $GITHUB_OUTPUT

            - name: Create Browser Extension Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ needs.detect-release-type.outputs.tag_name }}
                  release_name: Browser Extension ${{ needs.detect-release-type.outputs.tag_name }}
                  draft: false
                  prerelease: false
            - name: Upload browser extension zip
              uses: actions/upload-release-asset@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  upload_url: ${{ steps.create_release.outputs.upload_url }}
                  asset_path: ./${{ env.BROWSER_EXTENSION_NAME }}.zip
                  asset_name: ${{ env.BROWSER_EXTENSION_NAME }}-${{ steps.build.outputs.tag_name }}.zip
                  asset_content_type: application/zip
